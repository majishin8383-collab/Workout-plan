<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Heavy Duty Log (Simple)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0c10; color:#e8eaed; }
    .wrap { max-width: 1020px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 980px){ .grid { grid-template-columns: 380px 1fr; } }
    .card { background:#11131a; border:1px solid #222638; border-radius: 14px; padding: 12px; }
    .row { display:flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    label { font-size: 12px; opacity: .85; display:block; margin-bottom: 4px; }
    select, input, textarea, button {
      background:#0f1220; color:#e8eaed; border:1px solid #2a3050; border-radius: 10px;
      padding: 10px; font-size: 14px;
    }
    input, select { width: 100%; }
    textarea { width: 100%; min-height: 56px; resize: vertical; }
    button { cursor:pointer; }
    button.primary { background:#1c2550; border-color:#2f3aa0; }
    button.danger { background:#3a1020; border-color:#702040; }
    .small { font-size: 12px; opacity: .8; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#0f1220; border:1px solid #2a3050; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #222638; padding: 10px 8px; vertical-align: top; }
    th { text-align:left; font-size: 12px; opacity: .85; }
    .muted { opacity:.7; }
    .right { margin-left:auto; }
    .hidden { display:none; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .toast { margin-top:10px; font-size:12px; opacity:.85; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 0; }
    .tabbtn { padding:8px 10px; border-radius:999px; }
    .tabbtn.active { background:#1c2550; border-color:#2f3aa0; }
    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi .box { background:#0f1220; border:1px solid #2a3050; border-radius: 12px; padding: 10px; }
    .kpi .big { font-size: 18px; font-weight: 700; }
    .hr { height:1px; background:#222638; margin: 10px 0; }

    .mini { background:#0f1220; border:1px solid #2a3050; border-radius: 12px; padding: 10px; }
    .badge { padding: 6px 10px; border-radius: 999px; border: 1px solid #2a3050; background:#0f1220; font-size:12px; }
    .ok { border-color:#2f3aa0; }
    .warn { border-color:#705020; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      Heavy Duty Log
      <span class="pill" id="nextDayPill">Next: Day A</span>
      <span class="pill" id="nutritionPill">Nutrition: 0/2 shakes</span>
    </h1>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="small muted">Auto-fill last. Auto-progress suggestions. Cadence coach (4 down / 2 up).</div>
          <button id="btnSettings" title="Settings">⚙️</button>
        </div>

        <div class="tabs">
          <button class="tabbtn active" data-tab="plan">Plan</button>
          <button class="tabbtn" data-tab="entry">Entry</button>
          <button class="tabbtn" data-tab="nutrition">Nutrition</button>
          <button class="tabbtn" data-tab="growth">Growth</button>
        </div>

        <!-- TAB: PLAN -->
        <div id="tab_plan" style="margin-top:12px;">
          <div class="card">
            <div class="row">
              <div style="flex: 1 1 160px;">
                <label for="daySelectPlan">Preview Day</label>
                <select id="daySelectPlan">
                  <option value="A">Day A — Chest & Back</option>
                  <option value="B">Day B — Legs</option>
                  <option value="C">Day C — Delts & Arms</option>
                </select>
              </div>
              <div style="flex: 1 1 180px;">
                <label>Recovery Gate</label>
                <div class="small muted">Wait 3–4+ days as needed. Train when soreness is gone + spine feels quiet.</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div style="flex:1 1 auto;">
                <strong id="planTitle">Plan — Day A (Chest & Back)</strong>
                <ul id="planList" class="small muted" style="margin:8px 0 0; padding-left:18px;"></ul>
              </div>
            </div>
          </div>

          <div class="mini" style="margin-top:12px;">
            <div class="small muted">
              PR logic: beat the last entry for the same exercise/day (reps at same weight or weight at same reps).
              “Clean/controlled” unlocks progression suggestions.
            </div>
          </div>
        </div>

        <!-- TAB: ENTRY -->
        <div id="tab_entry" class="hidden" style="margin-top:12px;">
          <div class="card">
            <div class="row">
              <div style="flex: 1 1 120px;">
                <label for="daySelect">Day</label>
                <select id="daySelect">
                  <option value="A">Day A — Chest & Back</option>
                  <option value="B">Day B — Legs</option>
                  <option value="C">Day C — Delts & Arms</option>
                </select>
              </div>
              <div style="flex: 1 1 160px;">
                <label for="dateInput">Date</label>
                <input id="dateInput" type="date" />
              </div>
            </div>

            <div style="margin-top:10px;">
              <label for="exerciseSelect">Exercise</label>
              <select id="exerciseSelect"></select>
            </div>

            <!-- Auto-fill + suggestion panel -->
            <div class="mini" style="margin-top:10px;">
              <div class="row">
                <span class="badge" id="lastBadge">Last: —</span>
                <span class="badge ok" id="targetBadge">Target: —</span>
                <span class="badge warn" id="nextBadge">Next (if clean max): —</span>
              </div>
              <div class="small muted" style="margin-top:6px;">
                Auto-fills your last result. If you hit the top of the rep range <b>clean</b>, it suggests the next weight automatically.
              </div>
              <div class="row" style="margin-top:8px;">
                <button id="btnApplySuggested">Apply suggested target</button>
                <button id="btnUseLast">Load last</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div style="flex: 1 1 120px;">
                <label for="weightInput">Weight</label>
                <input id="weightInput" inputmode="decimal" placeholder="e.g., 133" />
              </div>
              <div style="flex: 1 1 120px;">
                <label for="repsInput">Reps</label>
                <input id="repsInput" inputmode="numeric" placeholder="e.g., 2" />
              </div>
              <div style="flex: 1 1 140px;">
                <label for="unitsSelect">Units</label>
                <select id="unitsSelect">
                  <option value="lb">lb</option>
                  <option value="kg">kg</option>
                  <option value="bw">bw</option>
                  <option value="bw+">bw+</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <label class="pill" style="margin:0;">
                <input type="checkbox" id="chkClean" />
                Clean + controlled (no cheat reps)
              </label>
              <span class="right small muted" id="lastComparison"></span>
            </div>

            <!-- Cadence coach -->
            <div class="mini" style="margin-top:10px;">
              <strong>Cadence Coach</strong>
              <div class="small muted" style="margin-top:6px;">
                Tap Start and follow the cues: <b>4 seconds down</b>, <b>2 seconds up</b>, rep counted for you.
                (Turn your media volume up.)
              </div>

              <div class="row" style="margin-top:10px;">
                <div style="flex: 1 1 120px;">
                  <label for="cadDown">Down (sec)</label>
                  <input id="cadDown" inputmode="numeric" value="4" />
                </div>
                <div style="flex: 1 1 120px;">
                  <label for="cadUp">Up (sec)</label>
                  <input id="cadUp" inputmode="numeric" value="2" />
                </div>
                <div style="flex: 1 1 140px;">
                  <label for="cadReps">Reps to cue</label>
                  <input id="cadReps" inputmode="numeric" value="8" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="primary" id="btnCadStart">Start</button>
                <button id="btnCadStop">Stop</button>
                <span class="right mono" id="cadStatus">Idle</span>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label for="notesInput">Notes (optional)</label>
              <textarea id="notesInput" placeholder="e.g., clean reps, no back tightness"></textarea>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="primary" id="btnAdd">Add to Log</button>
              <button id="btnQuickLast">Use last entry</button>
            </div>

            <div class="toast" id="toast"></div>
          </div>
        </div>

        <!-- TAB: NUTRITION -->
        <div id="tab_nutrition" class="hidden" style="margin-top:12px;">
          <div class="card">
            <strong>Targets (TRT + Heavy Duty + “I hate eating”)</strong>
            <div class="small muted" style="margin-top:6px;">
              Keep 2 meals/day. Add shakes to hit protein and calories without chewing.
            </div>

            <div class="kpi" style="margin-top:10px;">
              <div class="box">
                <div class="small muted">Calories</div>
                <div class="big">2,250–2,350</div>
                <div class="small muted">Adjust +150 only after 21 days flat.</div>
              </div>
              <div class="box">
                <div class="small muted">Protein</div>
                <div class="big">150–170 g</div>
                <div class="small muted">Two meals + 1–2 shakes.</div>
              </div>
              <div class="box">
                <div class="small muted">Carbs</div>
                <div class="big">180–220 g</div>
                <div class="small muted">Supports training performance.</div>
              </div>
              <div class="box">
                <div class="small muted">Fat</div>
                <div class="big">70–85 g</div>
                <div class="small muted">Joints + health + satiety.</div>
              </div>
            </div>

            <div class="hr"></div>

            <strong>Daily checklist</strong>
            <div class="row" style="margin-top:8px;">
              <label class="pill"><input type="checkbox" id="chkMeal1" /> Meal 1</label>
              <label class="pill"><input type="checkbox" id="chkMeal2" /> Meal 2</label>
              <label class="pill"><input type="checkbox" id="chkShake1" /> Shake #1 (Muscle Milk Pro 50)</label>
              <label class="pill"><input type="checkbox" id="chkShake2" /> Shake #2 (training/low appetite)</label>
              <label class="pill"><input type="checkbox" id="chkCreatine" /> Creatine</label>
              <label class="pill"><input type="checkbox" id="chkWater" /> Water</label>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="primary" id="btnSaveDaily">Save today</button>
              <button id="btnResetDaily">Reset today</button>
              <span class="right small muted" id="dailySavedText"></span>
            </div>

            <div class="hr"></div>

            <strong>Weekly weigh-in</strong>
            <div class="small muted">Once per week, same conditions (morning, after bathroom, before food).</div>

            <div class="row" style="margin-top:10px;">
              <div style="flex: 1 1 160px;">
                <label for="weighDate">Date</label>
                <input id="weighDate" type="date" />
              </div>
              <div style="flex: 1 1 160px;">
                <label for="weighValue">Bodyweight</label>
                <input id="weighValue" inputmode="decimal" placeholder="e.g., 160.4" />
              </div>
              <div style="flex: 1 1 200px;">
                <label for="weighNote">Note (optional)</label>
                <input id="weighNote" placeholder="sleep ok, appetite low, joints quiet" />
              </div>
              <div style="flex: 1 1 120px;">
                <label>&nbsp;</label>
                <button class="primary" id="btnAddWeigh">Add</button>
              </div>
            </div>

            <div style="margin-top:10px; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th style="width:120px;">Date</th>
                    <th style="width:120px;">Weight</th>
                    <th>Note</th>
                    <th style="width:90px;">Action</th>
                  </tr>
                </thead>
                <tbody id="weighBody"></tbody>
              </table>
            </div>

            <div class="small muted" style="margin-top:10px;">
              Goal trend: ~0.5–1.0 lb/week. If flat 3 weeks → add 1 extra shake on training days.
            </div>
          </div>
        </div>

        <!-- TAB: GROWTH -->
        <div id="tab_growth" class="hidden" style="margin-top:12px;">
          <div class="card">
            <strong>Natural TRT Growth Timeline (12 months)</strong>
            <div class="small muted" style="margin-top:6px;">
              You’re ~2 months in. Do the basics perfectly and let it compound.
            </div>

            <div class="hr"></div>
            <div><strong>Months 0–2 (now)</strong><div class="small muted">Stabilizing. Strength leads size. Lock rotation + shakes + weigh-ins.</div></div>
            <div class="hr"></div>
            <div><strong>Months 3–4</strong><div class="small muted">Fullness begins. Weight: +2–4 lb. PRs = bar speed + rep quality.</div></div>
            <div class="hr"></div>
            <div><strong>Months 5–6</strong><div class="small muted">First “it’s working” phase. Weight: +5–8 lb total. Shirts fit different.</div></div>
            <div class="hr"></div>
            <div><strong>Months 7–9</strong><div class="small muted">Density phase. Tendons catch up. Don’t increase frequency.</div></div>
            <div class="hr"></div>
            <div><strong>Months 10–12</strong><div class="small muted">Decision point: only consider “extras” if compliance is perfect and recovery is limiting.</div></div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="card hidden" id="settingsPanel" style="margin-top:12px;">
          <div class="row" style="justify-content:space-between;">
            <strong>Settings</strong>
            <button id="btnCloseSettings">✕</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnExport">Export Lift Log CSV</button>
            <button id="btnExportWeigh">Export Weigh-ins CSV</button>
            <button class="danger" id="btnClear">Clear Lift Log</button>
            <button class="danger" id="btnClearWeigh">Clear Weigh-ins</button>
          </div>

          <div class="small muted" style="margin-top:10px;">
            Data is stored locally in your browser (localStorage). Export CSV for backup.
          </div>
        </div>
      </div>

      <!-- RIGHT: LOG -->
      <div class="card">
        <div class="row">
          <strong>Lift Log</strong>
          <span class="right small muted" id="logCount"></span>
        </div>

        <div class="row" style="margin-top:10px;">
          <input id="searchInput" placeholder="Search (exercise, notes, day)…" style="flex:1 1 auto;" />
          <button id="btnToday">Today</button>
          <button id="btnDeleteLast" class="danger" title="Delete last entry">Delete last</button>
        </div>

        <div style="margin-top:10px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">Date</th>
                <th style="width:60px;">Day</th>
                <th>Exercise</th>
                <th style="width:160px;">Result</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>

        <div class="small muted" style="margin-top:10px;">
          Tip: Mark “Clean + controlled” when you truly earned it — that’s what triggers progression suggestions.
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------------- Plan ----------------
  const PLAN = {
    A: { title: "Day A — Chest & Back", exercises: [
      "Cable Flye (pre-exhaust)",
      "Incline Barbell Press (close grip)",
      "Dumbbell Pullover",
      "Weighted Pull-Ups (palms up)",
      "Seated Cable Row (or Landmine Row)"
    ]},
    B: { title: "Day B — Legs", exercises: [
      "Squat (maintenance / spine-aware)",
      "Dip-Belt Calf Raise"
    ]},
    C: { title: "Day C — Delts & Arms", exercises: [
      "Cable Lateral Raise",
      "Barbell Curl (via cable) + Rest-Pause",
      "Triceps Pressdown",
      "Dips (bodyweight)"
    ]}
  };

  // ------------- Rep ranges + progression (edit here) -------------
  // If reps >= repMax AND "Clean" checked => suggest +inc (lb) next time.
  // Units: lb (default), bw, bw+
  const RULES = {
    "Cable Flye (pre-exhaust)": { repMin: 8, repMax: 12, inc: 2.5, units: "lb" },
    "Incline Barbell Press (close grip)": { repMin: 1, repMax: 3, inc: 5, units: "lb" },
    "Dumbbell Pullover": { repMin: 6, repMax: 8, inc: 5, units: "lb" },
    "Weighted Pull-Ups (palms up)": { repMin: 1, repMax: 4, inc: 2.5, units: "bw+" },
    "Seated Cable Row (or Landmine Row)": { repMin: 6, repMax: 10, inc: 5, units: "lb" },
    "Squat (maintenance / spine-aware)": { repMin: 5, repMax: 6, inc: 5, units: "lb" },
    "Dip-Belt Calf Raise": { repMin: 10, repMax: 15, inc: 5, units: "lb" },
    "Cable Lateral Raise": { repMin: 10, repMax: 15, inc: 2.5, units: "lb" },
    "Barbell Curl (via cable) + Rest-Pause": { repMin: 1, repMax: 3, inc: 2.5, units: "lb" },
    "Triceps Pressdown": { repMin: 6, repMax: 10, inc: 5, units: "lb" },
    "Dips (bodyweight)": { repMin: 6, repMax: 8, inc: 0, units: "bw" },
  };

  // ---------------- Storage ----------------
  const KEY_LOG = "HD_LOG_V3";
  const KEY_DAILY = "HD_DAILY_V1";
  const KEY_WEIGH = "HD_WEIGH_V1";
  const KEY_TARGETS = "HD_TARGETS_V1"; // suggested next targets per exercise/day

  const loadJSON = (k, fallback) => {
    try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); }
    catch { return fallback; }
  };
  const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // ---------------- Helpers ----------------
  const $ = (id) => document.getElementById(id);
  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };
  const parseNum = (s) => {
    const n = Number(String(s).trim());
    return Number.isFinite(n) ? n : null;
  };
  const nextDay = (d) => (d === "A" ? "B" : d === "B" ? "C" : "A");
  const escapeHtml = (str) =>
    String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));

  function bestGuessNextDay(log) {
    if (!log.length) return "A";
    const lastEntry = [...log].sort((a,b)=> (b.ts||0)-(a.ts||0))[0];
    return nextDay(lastEntry.day);
  }

  function formatResult(e) {
    if (!e) return "—";
    if (e.units === "bw") return `bw × ${e.reps}`;
    if (e.units === "bw+") return `bw+${e.weight} × ${e.reps}`;
    return `${e.weight}${e.units} × ${e.reps}`;
  }

  function toast(msg) {
    $("toast").textContent = msg;
    setTimeout(()=> { if ($("toast").textContent === msg) $("toast").textContent = ""; }, 2500);
  }

  function updatePlanUI(day) {
    $("planTitle").textContent = `Plan — ${PLAN[day].title}`;
    $("planList").innerHTML = PLAN[day].exercises.map(x => `<li>${escapeHtml(x)}</li>`).join("");
    $("exerciseSelect").innerHTML = PLAN[day].exercises.map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
  }

  function renderLog(log) {
    const q = $("searchInput").value.trim().toLowerCase();
    const filtered = [...log].sort((a,b)=> (b.ts||0)-(a.ts||0)).filter(e => {
      if (!q) return true;
      const blob = `${e.date} ${e.day} ${e.exercise} ${e.notes||""} ${e.weight}${e.units}x${e.reps}`.toLowerCase();
      return blob.includes(q);
    });

    $("logCount").textContent = `${filtered.length} entries`;
    $("logBody").innerHTML = filtered.length ? filtered.map(e => `
      <tr>
        <td class="mono">${escapeHtml(e.date)}</td>
        <td><span class="pill">${escapeHtml(e.day)}</span></td>
        <td>${escapeHtml(e.exercise)}</td>
        <td class="mono">${escapeHtml(formatResult(e))}${e.clean ? " ✅" : ""}</td>
        <td class="muted">${escapeHtml(e.notes || "")}</td>
      </tr>
    `).join("") : `<tr><td colspan="5" class="muted">No entries yet. Add your first set.</td></tr>`;
  }

  function findLastForExercise(log, day, exercise) {
    return [...log].sort((a,b)=> (b.ts||0)-(a.ts||0)).find(e => e.day === day && e.exercise === exercise) || null;
  }

  function compareToLast(current, last) {
    if (!last) return "No previous entry";
    if (current.units !== last.units) return `Last: ${formatResult(last)}`;

    const cw = current.units === "bw" ? 0 : Number(current.weight || 0);
    const lw = last.units === "bw" ? 0 : Number(last.weight || 0);
    const cr = Number(current.reps);
    const lr = Number(last.reps);

    let verdict = "Matched last";
    if (cw === lw && cr > lr) verdict = "PR: more reps";
    else if (cr === lr && cw > lw) verdict = "PR: more weight";
    else if (cw > lw && cr > lr) verdict = "PR: weight + reps";
    else if (cw < lw && cr < lr) verdict = "Below last (fine on comeback)";

    return `${verdict} (Last: ${formatResult(last)})`;
  }

  // ---------------- Targets (auto-progress) ----------------
  // Store suggested next targets by key = `${day}||${exercise}`
  function keyOf(day, ex) { return `${day}||${ex}`; }

  function getRule(ex) { return RULES[ex] || null; }

  function computeSuggestedNext(ex, units, weightStr, repsNum, clean) {
    const r = getRule(ex);
    if (!r) return null;

    const repMax = r.repMax;
    const inc = r.inc;

    if (!clean) return null;
    if (repsNum < repMax) return null;
    if (inc <= 0) return null;

    // For bw: no weight progression suggested
    if (units === "bw") return null;

    const w = units === "bw+" ? Number(weightStr || 0) : Number(weightStr || 0);
    if (!Number.isFinite(w)) return null;

    const nextW = Math.round((w + inc) * 2) / 2; // keep .5 steps possible
    return { units, weight: String(nextW), repsTarget: r.repMin }; // keep target as low end of range
  }

  function setBadges(day, ex, last, targets) {
    const r = getRule(ex);
    const repRange = r ? `${r.repMin}–${r.repMax} reps` : "—";
    $("lastBadge").textContent = `Last: ${last ? formatResult(last) : "—"}`;
    $("targetBadge").textContent = `Target: ${repRange}`;
    const t = targets[keyOf(day, ex)] || null;
    $("nextBadge").textContent = `Next (if clean max): ${t ? (t.units==="bw+"?`bw+${t.weight}`:`${t.weight}${t.units}`) : "—"}`;
  }

  function applyAutoFill(day, ex) {
    const last = findLastForExercise(log, day, ex);
    const r = getRule(ex);

    // Auto fill with target if exists, else last, else defaults
    const t = targets[keyOf(day, ex)] || null;

    if (t) {
      $("unitsSelect").value = t.units;
      $("weightInput").value = t.weight || "";
      $("repsInput").value = "";
    } else if (last) {
      $("unitsSelect").value = last.units;
      $("weightInput").value = last.weight || "";
      $("repsInput").value = "";
    } else if (r) {
      $("unitsSelect").value = r.units || "lb";
      $("weightInput").value = "";
      $("repsInput").value = "";
    }

    setBadges(day, ex, last, targets);
    $("chkClean").checked = false;
    $("lastComparison").textContent = last ? `Last: ${formatResult(last)}` : "";
  }

  // ---------------- Cadence Coach ----------------
  let cadTimer = null;
  let cadState = { rep: 0, phase: "idle", secsLeft: 0, down: 4, up: 2, reps: 8 };

  function speak(text) {
    // speech synthesis (best "someone watching you" without camera)
    try {
      if (!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    } catch {}
  }

  function cadSetStatus() {
    $("cadStatus").textContent = cadState.phase === "idle"
      ? "Idle"
      : `Rep ${cadState.rep}/${cadState.reps} — ${cadState.phase} (${cadState.secsLeft}s)`;
  }

  function cadStop() {
    if (cadTimer) clearInterval(cadTimer);
    cadTimer = null;
    cadState.phase = "idle";
    cadState.rep = 0;
    cadState.secsLeft = 0;
    cadSetStatus();
    try { window.speechSynthesis?.cancel?.(); } catch {}
  }

  function cadStart(down, up, reps) {
    cadStop();
    cadState = { rep: 0, phase: "down", secsLeft: down, down, up, reps };
    cadSetStatus();
    speak("Start set. Rep 1. Down.");

    cadTimer = setInterval(() => {
      cadState.secsLeft -= 1;

      // cue countdown lightly
      if (cadState.secsLeft > 0) {
        if (cadState.secsLeft <= 3) speak(String(cadState.secsLeft));
        cadSetStatus();
        return;
      }

      // phase switch
      if (cadState.phase === "down") {
        cadState.phase = "up";
        cadState.secsLeft = cadState.up;
        speak("Up.");
        cadSetStatus();
        return;
      }

      if (cadState.phase === "up") {
        cadState.rep += 1;
        if (cadState.rep >= cadState.reps) {
          speak("Set complete.");
          cadStop();
          return;
        }
        cadState.phase = "down";
        cadState.secsLeft = cadState.down;
        speak(`Rep ${cadState.rep + 1}. Down.`);
        cadSetStatus();
        return;
      }
    }, 1000);
  }

  // ---------------- Nutrition (existing simple) ----------------
  let daily = loadJSON(KEY_DAILY, {});
  let weigh = loadJSON(KEY_WEIGH, []);

  function dayKey() { return todayISO(); }
  function loadDailyUI() {
    const k = dayKey();
    const d = daily[k] || {};
    $("chkMeal1").checked = !!d.meal1;
    $("chkMeal2").checked = !!d.meal2;
    $("chkShake1").checked = !!d.shake1;
    $("chkShake2").checked = !!d.shake2;
    $("chkCreatine").checked = !!d.creatine;
    $("chkWater").checked = !!d.water;
    $("dailySavedText").textContent = d.savedAt ? `Saved: ${new Date(d.savedAt).toLocaleTimeString()}` : "";
  }

  function refreshNutritionPill() {
    const k = dayKey();
    const d = daily[k] || {};
    const shakes = (d.shake1 ? 1 : 0) + (d.shake2 ? 1 : 0);
    $("nutritionPill").textContent = `Nutrition: ${shakes}/2 shakes`;
  }

  function renderWeigh() {
    const sorted = [...weigh].sort((a,b)=> (b.ts||0)-(a.ts||0));
    $("weighBody").innerHTML = sorted.length ? sorted.map(e => `
      <tr>
        <td class="mono">${escapeHtml(e.date)}</td>
        <td class="mono">${escapeHtml(e.weight)}</td>
        <td class="muted">${escapeHtml(e.note || "")}</td>
        <td><button class="danger" data-del="${e.ts}">Delete</button></td>
      </tr>
    `).join("") : `<tr><td colspan="4" class="muted">No weigh-ins yet.</td></tr>`;

    document.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const ts = Number(btn.getAttribute("data-del"));
        weigh = weigh.filter(w => w.ts !== ts);
        saveJSON(KEY_WEIGH, weigh);
        renderWeigh();
      });
    });
  }

  function exportCSV(log) {
    const header = ["date","day","exercise","weight","units","reps","clean","notes"].join(",");
    const lines = [...log].sort((a,b)=> (a.ts||0)-(b.ts||0)).map(e => {
      const safe = (v) => `"${String(v ?? "").replace(/"/g,'""')}"`;
      return [e.date, e.day, e.exercise, e.weight, e.units, e.reps, e.clean ? "1" : "0", e.notes].map(safe).join(",");
    });
    return [header, ...lines].join("\n");
  }

  function exportWeighCSV(weigh) {
    const header = ["date","weight","note"].join(",");
    const lines = [...weigh].sort((a,b)=> (a.ts||0)-(b.ts||0)).map(e => {
      const safe = (v) => `"${String(v ?? "").replace(/"/g,'""')}"`;
      return [e.date, e.weight, e.note].map(safe).join(",");
    });
    return [header, ...lines].join("\n");
  }

  function downloadText(text, filename, mime) {
    const blob = new Blob([text], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------------- Init ----------------
  let log = loadJSON(KEY_LOG, []);
  let targets = loadJSON(KEY_TARGETS, {}); // next target weights

  $("dateInput").value = todayISO();
  $("weighDate").value = todayISO();

  const defaultDay = bestGuessNextDay(log);
  $("daySelect").value = defaultDay;
  $("daySelectPlan").value = defaultDay;
  updatePlanUI(defaultDay);

  $("nextDayPill").textContent = `Next: Day ${defaultDay}`;
  renderLog(log);
  renderWeigh();
  loadDailyUI();
  refreshNutritionPill();

  // badges + auto fill initial exercise
  const ex0 = $("exerciseSelect").value;
  applyAutoFill($("daySelect").value, ex0);

  // ---------------- Tabs ----------------
  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.getAttribute("data-tab");
      ["plan","entry","nutrition","growth"].forEach(t => {
        $("tab_"+t).classList.toggle("hidden", t !== tab);
      });
    });
  });

  // Plan preview day
  $("daySelectPlan").addEventListener("change", () => {
    const day = $("daySelectPlan").value;
    $("planTitle").textContent = `Plan — ${PLAN[day].title}`;
    $("planList").innerHTML = PLAN[day].exercises.map(x => `<li>${escapeHtml(x)}</li>`).join("");
  });

  // Entry day change
  $("daySelect").addEventListener("change", () => {
    updatePlanUI($("daySelect").value);
    applyAutoFill($("daySelect").value, $("exerciseSelect").value);
  });

  // Exercise change => AUTO FILL last/target instantly
  $("exerciseSelect").addEventListener("change", () => {
    applyAutoFill($("daySelect").value, $("exerciseSelect").value);
  });

  // Manual load last
  $("btnUseLast").addEventListener("click", () => {
    const day = $("daySelect").value;
    const ex = $("exerciseSelect").value;
    const last = findLastForExercise(log, day, ex);
    if (!last) return toast("No last entry found.");
    $("unitsSelect").value = last.units;
    $("weightInput").value = last.weight || "";
    $("repsInput").value = "";
    toast("Loaded last weight.");
  });

  // Apply suggested target
  $("btnApplySuggested").addEventListener("click", () => {
    const day = $("daySelect").value;
    const ex = $("exerciseSelect").value;
    const t = targets[keyOf(day, ex)];
    if (!t) return toast("No suggested target yet.");
    $("unitsSelect").value = t.units;
    $("weightInput").value = t.weight || "";
    $("repsInput").value = "";
    toast("Applied suggested target.");
  });

  // Cadence coach buttons
  $("btnCadStart").addEventListener("click", () => {
    const down = parseNum($("cadDown").value);
    const up = parseNum($("cadUp").value);
    const reps = parseNum($("cadReps").value);
    if (!down || !up || !reps || down <= 0 || up <= 0 || reps <= 0) return toast("Enter valid cadence numbers.");
    cadStart(down, up, reps);
  });
  $("btnCadStop").addEventListener("click", () => cadStop());

  // Search
  $("searchInput").addEventListener("input", () => renderLog(log));

  // Today
  $("btnToday").addEventListener("click", () => {
    $("dateInput").value = todayISO();
    toast("Date set to today.");
  });

  // Add log entry (with auto-progression)
  $("btnAdd").addEventListener("click", () => {
    const day = $("daySelect").value;
    const date = $("dateInput").value || todayISO();
    const exercise = $("exerciseSelect").value;
    const units = $("unitsSelect").value;

    const reps = parseNum($("repsInput").value);
    if (!reps || reps <= 0) return toast("Enter reps (number).");

    let weight = $("weightInput").value.trim();
    if (units === "bw") {
      weight = "";
    } else {
      const w = parseNum(weight);
      if (w === null || w < 0) return toast("Enter weight (number).");
      weight = String(w);
    }

    const entry = {
      ts: Date.now(),
      date,
      day,
      exercise,
      weight,
      units,
      reps: String(reps),
      clean: $("chkClean").checked,
      notes: $("notesInput").value.trim()
    };

    const last = findLastForExercise(log, day, exercise);
    $("lastComparison").textContent = compareToLast(entry, last);

    // Save entry
    log.push(entry);
    saveJSON(KEY_LOG, log);
    renderLog(log);

    // Auto-progression suggestion: if clean + hit repMax => set "next target" for that exercise/day
    const suggested = computeSuggestedNext(exercise, units, weight, reps, entry.clean);
    if (suggested) {
      targets[keyOf(day, exercise)] = suggested;
      saveJSON(KEY_TARGETS, targets);
      toast(`Saved next target: ${suggested.units==="bw+" ? "bw+"+suggested.weight : suggested.weight+suggested.units}`);
    } else {
      toast("Saved.");
    }

    // update badges + next day pill
    const nd = bestGuessNextDay(log);
    $("nextDayPill").textContent = `Next: Day ${nd}`;

    // Clear only reps + notes + clean (keep weight for convenience)
    $("repsInput").value = "";
    $("notesInput").value = "";
    $("chkClean").checked = false;

    // refresh badges for current exercise
    applyAutoFill(day, exercise);
  });

  // Quick last entry button (fills last entire entry)
  $("btnQuickLast").addEventListener("click", () => {
    const day = $("daySelect").value;
    const ex = $("exerciseSelect").value;
    const last = findLastForExercise(log, day, ex);
    if (!last) return toast("No previous entry for this exercise/day.");
    $("unitsSelect").value = last.units;
    $("weightInput").value = last.weight || "";
    $("repsInput").value = last.reps || "";
    $("notesInput").value = last.notes || "";
    $("chkClean").checked = !!last.clean;
    toast("Loaded last entry.");
  });

  // Delete last entry
  $("btnDeleteLast").addEventListener("click", () => {
    if (!log.length) return toast("Log is empty.");
    const sortedIdx = log
      .map((e,i)=>({e,i}))
      .sort((a,b)=>(b.e.ts||0)-(a.e.ts||0))[0].i;
    const removed = log.splice(sortedIdx,1)[0];
    saveJSON(KEY_LOG, log);
    renderLog(log);
    const nd = bestGuessNextDay(log);
    $("nextDayPill").textContent = `Next: Day ${nd}`;
    toast(`Deleted: Day ${removed.day} — ${removed.exercise}`);
  });

  // Settings
  $("btnSettings").addEventListener("click", () => $("settingsPanel").classList.toggle("hidden"));
  $("btnCloseSettings").addEventListener("click", () => $("settingsPanel").classList.add("hidden"));
  $("btnExport").addEventListener("click", () => {
    downloadText(exportCSV(log), "heavy-duty-lift-log.csv", "text/csv;charset=utf-8");
    toast("Exported lift log CSV.");
  });
  $("btnExportWeigh").addEventListener("click", () => {
    downloadText(exportWeighCSV(weigh), "heavy-duty-weighins.csv", "text/csv;charset=utf-8");
    toast("Exported weigh-ins CSV.");
  });
  $("btnClear").addEventListener("click", () => {
    if (!confirm("Clear the entire LIFT log? This cannot be undone.")) return;
    log = [];
    saveJSON(KEY_LOG, log);
    renderLog(log);
    $("nextDayPill").textContent = `Next: Day A`;
    toast("Lift log cleared.");
  });
  $("btnClearWeigh").addEventListener("click", () => {
    if (!confirm("Clear the entire WEIGH-IN log? This cannot be undone.")) return;
    weigh = [];
    saveJSON(KEY_WEIGH, weigh);
    renderWeigh();
    toast("Weigh-ins cleared.");
  });

  // Nutrition save/reset
  $("btnSaveDaily").addEventListener("click", () => {
    const k = dayKey();
    daily[k] = {
      meal1: $("chkMeal1").checked,
      meal2: $("chkMeal2").checked,
      shake1: $("chkShake1").checked,
      shake2: $("chkShake2").checked,
      creatine: $("chkCreatine").checked,
      water: $("chkWater").checked,
      savedAt: Date.now()
    };
    saveJSON(KEY_DAILY, daily);
    loadDailyUI();
    refreshNutritionPill();
    toast("Saved nutrition for today.");
  });

  $("btnResetDaily").addEventListener("click", () => {
    if (!confirm("Reset today's checklist?")) return;
    delete daily[dayKey()];
    saveJSON(KEY_DAILY, daily);
    loadDailyUI();
    refreshNutritionPill();
    toast("Reset.");
  });

  // Weigh-ins
  $("btnAddWeigh").addEventListener("click", () => {
    const date = $("weighDate").value || todayISO();
    const w = parseNum($("weighValue").value);
    if (w === null || w <= 0) return toast("Enter bodyweight (number).");
    const note = $("weighNote").value.trim();
    weigh.push({ ts: Date.now(), date, weight: String(w), note });
    saveJSON(KEY_WEIGH, weigh);
    renderWeigh();
    $("weighValue").value = "";
    $("weighNote").value = "";
    toast("Weigh-in added.");
  });

  // Keep nutrition pill current if day flips while open
  setInterval(() => {
    loadDailyUI();
    refreshNutritionPill();
  }, 60 * 1000);

})();
</script>
</body>
</html>
